import React, { useState, useRef, useEffect } from 'react';
import SignatureCanvas from 'react-signature-canvas';
import './TBMChecklist.css';

// --- 백엔드 API로부터 받아올 팀과 점검표 데이터에 대한 Mock(모의) 함수 ---
const fetchChecklistDataByTeam = async (teamId) => {
  console.log(`${teamId}번 팀의 점검표 데이터를 서버에 요청합니다...`);

  const allData = {
    '1': { // 조립 전기라인
      templateName: "조립 전기라인 일일 안전점검 / TBM 활동지",
      items: [
        { id: 1, category: 'TBM 평가', subCategory: '지시', description: '아침 체조 스트레칭' },
        { id: 2, category: 'TBM 평가', subCategory: '지시', description: '건강상태/복장상태/보호구' },
        { id: 3, category: 'TBM 평가', subCategory: '위험예지훈련', description: '입고, 출고, 조립, 가공 등 공정 순서(작업방법)에 대한 위험' },
        { id: 4, category: '관리 감독자', subCategory: '지적확인', description: '중량 위험요인 선행 구조 재검토(중량도 높은 사항으로 지정)' },
      ]
    },
    '2': { // 제관라인
      templateName: "제관라인 일일 안전점검 / TBM 활동지",
      items: [
        { id: 5, category: 'TBM 평가', subCategory: '도입', description: '아침 체조 스트레칭' },
        { id: 6, category: 'TBM 평가', subCategory: '건강/복장/보호구', description: '음주상태 / 건강상태 / 복장 / 보호구' },
        { id: 7, category: 'TBM 평가', subCategory: '위험예지훈련', description: '작업장소 등 변경에 대한 위험' },
      ]
    },
    '3': { // 가공라인
      templateName: "가공라인 일일 안전점검 / TBM 활동지",
      items: [
        { id: 10, category: 'TBM 평가', subCategory: '작업내용 전파', description: '생산회의의 당일 안전작업 내용지시' },
        { id: 11, category: 'TBM 평가', subCategory: '위험예지훈련', description: '크레인, 리프트, 지게차 등 설비에 대한 위험' },
      ]
    }
    // ... 4번 ~ 9번 팀 데이터
  };
  return new Promise(resolve => setTimeout(() => resolve(allData[teamId]), 500));
};

// 9개 팀 목록
const teams = [
  { id: 1, name: '조립 전기라인' }, { id: 2, name: '제관라인' },
  { id: 3, name: '가공라인' }, { id: 4, name: '연구소' },
  { id: 5, name: '지재/부품/출하' }, { id: 6, name: '서비스' },
  { id: 7, name: '품질' }, { id: 8, name: '인사총무팀' },
  { id: 9, name: '생산기술팀' }
];

const TBMChecklist = () => {
  const [selectedTeam, setSelectedTeam] = useState(teams[0].id);
  const [checklistData, setChecklistData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [checkResults, setCheckResults] = useState({});
  const sigPad = useRef(null);

  useEffect(() => {
    setLoading(true);
    setCheckResults({});
    fetchChecklistDataByTeam(selectedTeam).then(data => {
      setChecklistData(data);
      setLoading(false);
    });
  }, [selectedTeam]);

  // ... (handleCheck, clearSignature, handleSubmit 함수는 이전과 동일)
  const handleCheck = (itemId, value) => {
    setCheckResults(prev => ({ ...prev, [itemId]: value }));
  };

  const clearSignature = () => sigPad.current.clear();

  const handleSubmit = () => {
    const signatureImage = sigPad.current.isEmpty() 
      ? null 
      : sigPad.current.getTrimmedCanvas().toDataURL('image/png');

    const submissionData = {
      reportDate: new Date().toISOString().slice(0, 10),
      teamId: selectedTeam,
      managerName: "홍길동",
      results: checkResults,
      signature: signatureImage,
      remarks: "특이사항 없음"
    };

    console.log("제출 데이터:", submissionData);
    alert(`${teams.find(t=>t.id === selectedTeam).name} 점검표가 제출되었습니다.`);
  };


  return (
    <div className="checklist-container">
      <div className="header-section">
        <h1>2025년 ( )월 관리감독자 일일 안전점검 / TBM 활동지</h1>
        <div className="team-selector">
          <label htmlFor="team">팀 선택:</label>
          <select id="team" value={selectedTeam} onChange={e => setSelectedTeam(parseInt(e.target.value))}>
            {teams.map(team => <option key={team.id} value={team.id}>{team.name}</option>)}
          </select>
        </div>
      </div>

      {loading ? (
        <p>점검표를 불러오는 중입니다...</p>
      ) : checklistData ? (
        <>
          <div className="info-bar">
            <span><b>부서명:</b> {teams.find(t => t.id === selectedTeam)?.name}</span>
            <span><b>관리감독자:</b> 홍길동 (인)</span>
            <span><b>작성일:</b> {new Date().toLocaleDateString()}</span>
          </div>

          <table className="checklist-table">
            <thead>
              <tr>
                <th>구분</th>
                <th>중분류</th>
                <th>점검 내용</th>
                <th>결과 ( O: 양호, △: 관찰, X: 불량 )</th>
              </tr>
            </thead>
            <tbody>
              {checklistData.items.map(item => (
                <tr key={item.id}>
                  <td>{item.category}</td>
                  <td>{item.subCategory}</td>
                  <td className="description-cell">{item.description}</td>
                  <td className="result-buttons">
                    {['O', '△', 'X'].map(opt => (
                      <label key={opt} className={checkResults[item.id] === opt ? 'selected' : ''}>
                        <input
                          type="radio"
                          name={`item-${item.id}`}
                          value={opt}
                          checked={checkResults[item.id] === opt}
                          onChange={() => handleCheck(item.id, opt)}
                        />
                        {opt}
                      </label>
                    ))}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>

          <div className="footer-section">
             <div className="remarks-section">
                <h4>참고 사항 (TBM 일지)</h4>
                <textarea rows="6" defaultValue="1. 금일 TBM 실시 ..."></textarea>
            </div>
            <div className="signature-section">
                <h4>관리감독자 확인 서명</h4>
                <div className="signature-pad">
                    <SignatureCanvas 
                    ref={sigPad}
                    penColor='black'
                    canvasProps={{width: 300, height: 150, className: 'sig-canvas'}}
                    />
                </div>
                <button onClick={clearSignature}>다시 서명</button>
            </div>
          </div>
          <button className="submit-button" onClick={handleSubmit}>최종 제출</button>
        </>
      ) : (
        <p>해당 팀의 점검표를 찾을 수 없습니다.</p>
      )}
    </div>
  );
};

export default TBMChecklist;